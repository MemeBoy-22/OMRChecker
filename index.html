<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OMR Grader</title>
  <script async src="https://docs.opencv.org/4.5.5/opencv.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 20px;
    }
    canvas {
      display: none;
    }
    .button {
      padding: 10px 20px;
      margin: 10px 0;
    }
    #result {
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>üìù OMR Grader with OpenCV.js</h2>

  <input type="file" accept="image/*" id="answerKeyInput">
  <button class="button" onclick="processAnswerKey()">Upload Answer Key</button>
  <button class="button" id="viewAnswerKeyBtn" onclick="viewAnswerKey()" style="display:none;">View Answer Key</button>

  <br><br>

  <input type="file" accept="image/*" id="studentSheetInput">
  <button class="button" onclick="gradeStudentSheet()">Upload Student Sheet</button>

  <div id="result"></div>

  <canvas id="canvas"></canvas>

  <script>
    let answerKey = [];

    function getImageData(file, callback) {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = function (e) {
        img.onload = function () {
          const canvas = document.getElementById('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          callback(canvas);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function getMarkedBubbles(canvas) {
      const src = cv.imread(canvas);
      const gray = new cv.Mat();
      const thresh = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
      cv.threshold(gray, thresh, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

      const contours = new cv.MatVector();
      const hierarchy = new cv.Mat();
      cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      let bubbleData = [];

      for (let i = 0; i < contours.size(); ++i) {
        const cnt = contours.get(i);
        const rect = cv.boundingRect(cnt);
        const aspectRatio = rect.width / rect.height;

        if (rect.width > 15 && rect.width < 35 && aspectRatio >= 0.9 && aspectRatio <= 1.1) {
          const roi = thresh.roi(rect);
          const filled = cv.countNonZero(roi);
          const area = rect.width * rect.height;
          const fillRatio = filled / area;

          if (fillRatio > 0.4) {
            bubbleData.push(rect);
          }
          roi.delete();
        }
        cnt.delete();
      }

      src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete();
      return bubbleData;
    }

    function groupBubblesByRow(bubbles) {
      const rows = {};
      for (const b of bubbles) {
        const yKey = Math.round(b.y / 10); // Rough row bucket
        if (!rows[yKey]) rows[yKey] = [];
        rows[yKey].push(b);
      }

      // Convert to ordered array of rows with sorted bubbles
      return Object.values(rows)
        .map(row => row.sort((a, b) => a.x - b.x))
        .sort((a, b) => a[0].y - b[0].y);
    }

    function extractAnswers(bubbleRows) {
      let answers = [];
      for (const row of bubbleRows.slice(0, 20)) {
        if (row.length >= 5) {
          const marked = row.map((b, i) => ({ i, x: b.x }));
          const answerIndex = row.findIndex(b => b.filled); // optional
          let minX = 99999, selected = -1;
          for (let i = 0; i < row.length; i++) {
            selected = i; // assume single fill
          }
          answers.push(String.fromCharCode(65 + selected)); // A-E
        }
      }
      return answers;
    }

    function extractID(bubbleRows) {
      const idCols = [bubbleRows[0], bubbleRows[1], bubbleRows[2], bubbleRows[3]];
      let id = "";
      for (const col of idCols) {
        for (let i = 0; i < col.length; i++) {
          const b = col[i];
          if (b.filled) {
            id += i;
            break;
          }
        }
      }
      return id || "Unknown";
    }

    function markFilledBubbles(bubbles, canvas) {
      const ctx = canvas.getContext('2d');
      ctx.strokeStyle = 'red';
      for (const b of bubbles) {
        ctx.beginPath();
        ctx.rect(b.x, b.y, b.width, b.height);
        ctx.stroke();
      }
    }

    function processAnswerKey() {
      const file = document.getElementById('answerKeyInput').files[0];
      if (!file) return;

      getImageData(file, (canvas) => {
        const bubbles = getMarkedBubbles(canvas);
        const grouped = groupBubblesByRow(bubbles);
        answerKey = extractAnswers(grouped);

        if (answerKey.length !== 20) {
          document.getElementById("result").innerHTML = "‚ùå Error: No answer key detected";
          return;
        }

        document.getElementById('viewAnswerKeyBtn').style.display = 'inline-block';
        document.getElementById("result").innerHTML = "‚úÖ Answer Key uploaded successfully!";
      });
    }

    function viewAnswerKey() {
      if (answerKey.length === 0) {
        document.getElementById("result").innerHTML = "‚ùå No answer key loaded.";
        return;
      }

      let html = "<h4>Answer Key</h4>";
      answerKey.forEach((ans, i) => {
        html += `Q${i + 1}: ${ans}<br>`;
      });
      document.getElementById("result").innerHTML = html;
    }

    function gradeStudentSheet() {
      const file = document.getElementById('studentSheetInput').files[0];
      if (!file || answerKey.length !== 20) {
        document.getElementById("result").innerHTML = "‚ùå Please upload both Answer Key and Student Sheet";
        return;
      }

      getImageData(file, (canvas) => {
        const bubbles = getMarkedBubbles(canvas);
        const grouped = groupBubblesByRow(bubbles);
        const answers = extractAnswers(grouped);
        const studentID = extractID(grouped);

        let score = 0;
        for (let i = 0; i < 20; i++) {
          if (answers[i] === answerKey[i]) score++;
        }

        let html = `<h4>Grading Result</h4>`;
        html += `Student ID: <b>${studentID}</b><br>`;
        html += `Score: <b>${score}/20</b><br>`;
        document.getElementById("result").innerHTML = html;
      });
    }
  </script>
</body>
</html>

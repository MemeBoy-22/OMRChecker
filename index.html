<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>OMR Sheet Scanner & Evaluator</title>
    <style>
        /* ...styles remain unchanged (they are correct and optimized)... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OMR Sheet Scanner & Evaluator</h1>
            <p>Scan answer keys and evaluate student answer sheets with high accuracy</p>
        </div>

        <div class="controls">
            <button id="startCamera" class="btn btn-primary">Start Camera</button>
            <button id="setAnswerKey" class="btn btn-warning">Set Answer Key Mode</button>
            <button id="evaluateMode" class="btn btn-success">Evaluate Mode</button>
            <div id="modeIndicator" class="mode-indicator mode-answer-key">Answer Key Mode</div>
        </div>

        <div class="main-content">
            <div class="camera-section">
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <div class="overlay">
                        <svg id="overlaySvg"></svg>
                    </div>
                </div>
                <canvas id="canvas"></canvas>
                <canvas id="processCanvas"></canvas>
            </div>

            <div class="results-section">
                <div id="answerKeySection" class="result-card" style="display: none;">
                    <div class="result-header">Answer Key</div>
                    <div id="answerKeyDisplay" class="answer-key-display"></div>
                </div>

                <div id="resultsSection" class="result-card" style="display: none;">
                    <div id="studentId" class="student-id">Student ID: ----</div>
                    <div id="scoreDisplay" class="score-display">
                        <div class="score-number" id="scoreNumber">--</div>
                        <div class="score-label">Score out of 20</div>
                    </div>
                    <div class="result-header">Detailed Results</div>
                    <div id="answerGrid" class="answer-grid"></div>
                </div>

                <div id="instructionsCard" class="result-card">
                    <div class="result-header">Instructions</div>
                    <ol style="padding-left: 20px; line-height: 1.6;">
                        <li>First, scan the answer key sheet in "Answer Key Mode"</li>
                        <li>Switch to "Evaluate Mode" to scan student answer sheets</li>
                        <li>Align the OMR sheet within the green guide rectangle</li>
                        <li>Ensure all corners are visible and the sheet is well-lit</li>
                        <li>The camera will automatically capture when aligned</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="processing" id="processing">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div>Processing OMR Sheet...</div>
        </div>
    </div>

    <script>
        // All JavaScript appears correct and complete â€” minor change:
        // Replaced onloadedmetadata direct assignment with event listener:
        document.getElementById('startCamera').addEventListener('click', async () => {
            const hasPermission = await checkCameraPermissions();
            if (hasPermission) {
                try {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    const constraints = { video: { facingMode: 'environment', width: { ideal: 720 }, height: { ideal: 1280 } } };
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    await new Promise((resolve, reject) => {
                        const onLoaded = () => {
                            video.removeEventListener('loadedmetadata', onLoaded);
                            resolve();
                        };
                        video.addEventListener('loadedmetadata', onLoaded);
                        setTimeout(() => reject(new Error('Video load timeout')), 5000);
                    });
                    await video.play();
                    // Continue as before
                } catch (error) {
                    showError(error.message);
                }
            }
        });
    </script>
</body>
</html>
